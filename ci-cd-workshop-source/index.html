
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Android Academy CI/CD Workshop Dec 2020</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="ci-cd-workshop-source"
                  title="Android Academy CI/CD Workshop Dec 2020"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="Repository Setup" duration="5">
        <ol type="1">
<li>Create a new application in Android Studio (or use your own previously created one).</li>
<li>Build and compile a project.</li>
<li>Create a Github repository for this project(or skip to the step 4 if you already have one). You can follow the instructions <a href="https://docs.github.com/en/free-pro-team@latest/github/getting-started-with-github/create-a-repo" target="_blank">here</a>.</li>
<li>Optional step - Create first commit (we just want to verify your local copy is synced with Github repo and we can start work on CI/CD). From the app root folder, open terminal and run:</li>
</ol>
<pre><code language="language-bash" class="language-bash">	git add .
	git commit -m &#34;Initial commit&#34;
	git push origin master
``` 

#### Congrats! We can start with CI related files now :)

&lt;!-- ------------------------ --&gt;
##  Run your first CI build
Duration: 0:05:00

### Add workflow file

&lt;span&gt;1.&lt;/span&gt; Go to project and a directory `.github` in the root.&lt;br/&gt;
&lt;span&gt;2.&lt;/span&gt; Inside it, create another directory called `workflows` (This is where all the GitHub Actions configuration files go).&lt;br/&gt;
&lt;span&gt;3.&lt;/span&gt; Create first configuration file `workflow_1.yaml`.&lt;br/&gt;
&lt;span&gt;4.&lt;/span&gt; Open it and add next code (make sure the indentation is exact as in the example, as yaml is sensitive to indentations):

```yaml
name: &#34;CI Workflow&#34;
on: [push]
	
jobs: 
  build: 
    name: &#34;Build project&#34;
    runs-on: ubuntu-latest
    steps: 
      - name: &#34;Checkout current repository in ubuntu&#39;s file system&#34;
        uses: actions/checkout@v1
      - name: &#34;Setup JDK 1.8&#34;
        uses: actions/setup-java@v1
        with: 
          java-version: 1.8
      - name: &#34;Builds debug build&#34;
        run: ./gradlew assembleDebug
</code></pre>
<p><br>5. Commit ang push the changes to origin:</p>
<pre><code language="language-bash" class="language-bash">git add .
git commit -m &#34;Initial CI script&#34;
git push origin master
</code></pre>
<p><br>6. You should see a result: <img alt="image_caption" src="img/d68117fa9036958d.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Add Unit Tests" duration="3">
        <h2 is-upgraded>First run unit tests locally</h2>
<p>1. Go to your test folder.<br>2. Locate <code>ExampleUnitTest.kt</code> or other test files and validate the test passes locally by running in command line<br></p>
<pre><code language="language-bash" class="language-bash">./gradlew testDebugUnitTest
</code></pre>
<h2 is-upgraded>Modify <code>workflow_1.yaml</code> file:</h2>
<p>1. Add to the bottom of your workfow file:<br></p>
<pre><code language="language-yaml" class="language-yaml">- name: Unit tests
  run: ./gradlew testDebugUnitTest
</code></pre>
<p>2. Commit and push the changes:</p>
<pre><code language="language-bash" class="language-bash">git commit -m &#34;Add unit test to the workflow&#34;
git push origin master
</code></pre>
<p>3. Verify your remote CI build triggers and passes.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Convert to (unsigned) release build" duration="3">
        <h2 is-upgraded>Modify <code>workflow_1.yaml</code> file</h2>
<p>1. Change from:<br><code>./gradlew assembleDebug</code> to <code>./gradlew assembleRelease</code><br>2. Change from:<br> <code>./gradlew testDebugUnitTest</code> to <code>./gradlew testReleaseUnitTest</code><br>3. Commit ang push the changes:</p>
<pre><code language="language-bash" class="language-bash">git commit -m &#34;Convert build to release&#34;
git push origin master
</code></pre>
<h3 is-upgraded>Now we have a remote build, that creates release APK, but it is unsigned ðŸ˜¢.</h3>


      </google-codelab-step>
    
      <google-codelab-step label="Signing your release" duration="0">
        <h2 is-upgraded>Create release.keystore file if not exist yet (skip this step if already have one)</h2>
<ol type="1">
<li>Go to <code>Android Studio -> Build -> Generate Signed Bundle or APK</code>.</li>
<li>Choose APK and click <code>Next</code>.</li>
<li>In the <code>Keystore Path</code> click <code>Create new...</code>.</li>
<li>Follow wizard instructions, fill relevant data and remember created keystore location.</li>
<li>Continue the wizard and build release.apk, just to verify that we are able to build a release version of the app locally.</li>
</ol>
<h2 is-upgraded>Modify your app/build.gradle</h2>
<p>Add next lines inside <code>android</code> closure:</p>
<pre><code language="language-gradle" class="language-gradle">    signingConfigs {

        //... 

        release {
            storeFile file(&#39;keystore.release&#39;)
            keyAlias System.getenv(&#34;MY_APP_KEY_ALIAS&#34;)
            storePassword System.getenv(&#34;MY_APP_STORE_PASSWORD&#34;)
            keyPassword System.getenv(&#34;MY_APP_KEY_PASSWORD&#34;)
        }

        buildTypes {
            release {
                // ...
                signingConfig signingConfigs.release
                // ...
            }
        }
    }

</code></pre>
<h2 is-upgraded>Configure environment variables in the Github Repository</h2>
<p>1. Go to the github project repository.<br>2. Follow the Settings tab.<br>3. In the Settings tab go to Secrets on the left menu (If you can&#39;t see it - maybe you don&#39;t have permissions for this project).<br></p>
<p class="image-container"><img alt="image_caption" src="img/776949dee3019677.png"></p>
<p>4.  Now click on the &#34;New Repository Secret&#34; on the right top.<br>5.  Give it a name <code>MY_APP_KEY_ALIAS</code> and a value you chosen before <code>your value</code> and click <code>Add secret</code>:<br><img alt="image_caption" src="img/dd9427641cfc012e.jpg"><br>6.  Repeat steps 4-5 for the <code>MY_APP_STORE_PASSWORD</code> and <code>MY_APP_KEY_PASSWORD</code>.<br></p>
<h2 is-upgraded>Upload release.keystore to Github secrets</h2>
<p>As we can not upload any files to Github secrets besides strings, we are going to convert our release.keystore to base64 string, store it and during the build process we will convert it back to file.</p>
<h3 is-upgraded>Generate base64 string from release.keystore file</h3>
<ol type="1">
<li>Open terminal in the folder where the keystore located at.</li>
<li>Run <code>base64 -w 0 release.keystore | xclip -selection clipboard</code>(It will also copy the created string to your clipboard).</li>
</ol>
<h3 is-upgraded>Add keystore string to Github secrets (same as we did for the passwords and alias)</h3>
<ol type="1">
<li>Go to your <code>Github repository -> Settings -> Secrets</code>.</li>
<li>Create new secret and give it name <code>ENCODED_KEYSTORE</code>.</li>
<li>Paste previously copied string as secret value and save the secret.</li>
</ol>
<h3 is-upgraded>Modify <code>workflow_1.yaml</code> file</h3>
<p>1. Add next lines after <code>Grant rights</code>:<br></p>
<pre><code language="language-yaml" class="language-yaml">- name: Restore release keystore
  run: echo &#34;$&#123;&#123; secrets.SIGNING_KEY }}&#34; | base64 --decode &gt; keystore.release
</code></pre>
<p>2. Also modify current <code>Generate APK</code> step:</p>
<pre><code language="language-yaml" class="language-yaml">- name: Generate APK
  run: ./gradlew assembleRelease
  env:
    MY_APP_STORE_PASSWORD: $&#123;&#123; secrets.MY_APP_STORE_PASSWORD }}
    MY_APP_KEY_PASSWORD: $&#123;&#123; secrets.MY_APP_KEY_PASSWORD }}
    MY_APP_KEY_ALIAS: $&#123;&#123; secrets.MY_APP_KEY_ALIAS }}
</code></pre>
<p><br>3. Commit and push your code and verify build passes.</p>
<h3 is-upgraded>Now we have a signed release.apk that we can distribute to our testers. Let&#39;s see how to do it ih the next step.</h3>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
